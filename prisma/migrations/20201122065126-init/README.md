# Migration `20201122065126-init`

This migration has been generated by Devrsi0n at 11/22/2020, 2:51:26 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."Role" AS ENUM ('USER', 'ADMIN')

CREATE TYPE "public"."UserType" AS ENUM ('FREE', 'PRO')

CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "googleUserId" TEXT,
    "githubUserId" TEXT,
    "avatar" TEXT,
    "type" "UserType" NOT NULL DEFAULT E'FREE',

    PRIMARY KEY ("id")
)

CREATE TABLE "Member" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,
    "teamId" TEXT NOT NULL,
    "role" "Role" NOT NULL DEFAULT E'USER',

    PRIMARY KEY ("id")
)

CREATE TABLE "Team" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Project" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "name" TEXT NOT NULL,
    "teamId" TEXT,
    "userId" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "Page" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "url" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "projectId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "Comment" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "userId" TEXT NOT NULL,
    "content" JSONB NOT NULL,
    "pageId" TEXT NOT NULL,
    "commentId" TEXT,

    PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "User.email_unique" ON "User"("email")

CREATE UNIQUE INDEX "User.googleUserId_unique" ON "User"("googleUserId")

CREATE UNIQUE INDEX "User.githubUserId_unique" ON "User"("githubUserId")

ALTER TABLE "Member" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Member" ADD FOREIGN KEY("teamId")REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Project" ADD FOREIGN KEY("teamId")REFERENCES "Team"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "Project" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "Page" ADD FOREIGN KEY("projectId")REFERENCES "Project"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Comment" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Comment" ADD FOREIGN KEY("pageId")REFERENCES "Page"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Comment" ADD FOREIGN KEY("commentId")REFERENCES "Comment"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201122065126-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,105 @@
+// This is your Prisma schema file,
+// learn more about it in the docs: https://pris.ly/d/prisma-schema
+
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+generator client {
+  provider        = "prisma-client-js"
+  // previewFeatures = ["nativeTypes"]
+}
+
+model User {
+  id           String    @id @default(cuid())
+  createdAt    DateTime  @default(now())
+  updatedAt    DateTime  @updatedAt
+  name         String
+  email        String    @unique
+  googleUserId String?   @unique
+  githubUserId String?   @unique
+  avatar       String?
+  members      Member[]
+  // A `PRO` user can create multiple teamsï¼Œbut a `FREE` user can't
+  type         UserType  @default(FREE)
+  // A free user can create 3 projects at most
+  projects     Project[]
+  comment      Comment[]
+}
+
+model Member {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  user      User     @relation(fields: [userId], references: [id])
+  userId    String
+  team      Team     @relation(fields: [teamId], references: [id])
+  teamId    String
+  role      Role     @default(USER)
+}
+
+model Team {
+  id        String    @id @default(cuid())
+  createdAt DateTime  @default(now())
+  updatedAt DateTime  @updatedAt
+  name      String
+  members   Member[]
+  project   Project[]
+}
+
+// A project is associated with a `FREE` user or a Team(create by `PRO` user)
+// A project has multiple pages
+model Project {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  // 64 chars
+  name      String
+  team      Team?    @relation(fields: [teamId], references: [id])
+  teamId    String?
+  user      User?    @relation(fields: [userId], references: [id])
+  userId    String?
+  pages     Page[]
+}
+
+// A page has multiple comments
+model Page {
+  id        String    @id @default(cuid())
+  createdAt DateTime  @default(now())
+  updatedAt DateTime  @updatedAt
+  // Embedded page's url, should not include query parameter. e.g. /post?id=123
+  url       String
+  title     String
+  comments  Comment[]
+  project   Project   @relation(fields: [projectId], references: [id])
+  projectId String
+}
+
+model Comment {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  user    User   @relation(fields: [userId], references: [id])
+  userId  String
+  // User input: Slate.js data
+  content Json
+
+  page   Page   @relation(fields: [pageId], references: [id])
+  pageId String
+
+  replies   Comment[] @relation("RepliesToComment")
+  comment   Comment?  @relation("RepliesToComment", fields: [commentId], references: [id])
+  commentId String?
+}
+
+enum Role {
+  USER
+  ADMIN
+}
+
+enum UserType {
+  FREE
+  PRO
+}
```


